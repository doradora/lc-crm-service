{% extends "crm/base.html" %}
{% block content %}
  <div class="card card-flush" id="users_list">
    <div class="card-header align-items-center py-5 gap-2 gap-md-5">
      <div class="card-title">
        <div class="d-flex align-items-center position-relative my-1">
          <div class="input-group mb-5">
            <i class="ki-outline ki-magnifier fs-3 position-absolute ms-4"></i>
            <input type="text"
                   v-model="searchQuery"
                   class="form-control form-control-solid w-250px ps-12"
                   placeholder="搜尋使用者" />
            <button class="btn btn-light" @click="fetchUsers()">搜尋</button>
          </div>
        </div>
      </div>
      <div class="card-toolbar flex-row-fluid justify-content-end gap-5">
        <div class="w-100 mw-150px">
          <select class="form-select form-select-solid"
                  v-model="roleFilter"
                  @change="fetchUsers(1)"
                  data-control="select2"
                  data-hide-search="true"
                  data-placeholder="角色">
            <option value="">所有</option>
            <option value="is_admin">管理員</option>
            <option value="is_designer">設計師</option>
            <option value="is_project_manager">專案經理</option>
          </select>
        </div>
        <a href="{% url 'users_index' %}" class="btn btn-primary">新增使用者</a>
      </div>
    </div>
    <!--end::Card header-->
    <!--begin::Card body-->
    <div class="card-body pt-0">
      <div v-if="isLoading" class="d-flex justify-content-center py-10">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">載入中...</span>
        </div>
      </div>
      <table class="table align-middle table-row-dashed fs-6 gy-5">
        <thead>
          <tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
            <th class="min-w-200px">使用者</th>
            <th class="text-end min-w-100px">電話</th>
            <th class="text-end min-w-100px">角色</th>
            <th class="text-end min-w-100px">創建時間</th>
            <th class="text-end min-w-70px">操作</th>
          </tr>
        </thead>
        <tbody class="fw-semibold text-gray-600">
          <tr v-for="user in users" :key="user.id">
            <td>
              <div class="d-flex align-items-center">
                <div class="ms-5">
                  <a class="text-gray-800 text-hover-primary fs-5 fw-bold">[[ user.profile.name || user.username ]]</a>
                  <div class="text-muted">[[ user.email ]]</div>
                </div>
              </div>
            </td>
            <td class="text-end pe-0">
              <span class="fw-bold">[[ user.profile.phone ]]</span>
            </td>
            <td class="text-end pe-0">
              <div class="badge" :class="getRoleBadgeClass(user.profile)">[[ getRoleText(user.profile) ]]</div>
            </td>
            <td class="text-end pe-0">[[ formatDate(user.profile.created_at) ]]</td>
            <td class="text-end">
              <a href="#"
                 class="btn btn-sm btn-light btn-flex btn-center btn-active-light-primary"
                 @click.prevent="toggleMenu(user.id)">
                操作
                <i class="ki-outline ki-down fs-5 ms-1"></i>
              </a>
              <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4"
                   data-kt-menu="true"
                   :style="getMenuStyle(user.id)"
                   :class="{'show': activeMenu === user.id}">
                <div class="menu-item px-3">
                  <a class="menu-link px-3">編輯</a>
                </div>
                <div class="menu-item px-3">
                  <a class="menu-link px-3" @click.prevent="deleteUser(user.id)">刪除</a>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- 分頁控制 -->
      <div class="pagination">
        <button @click="fetchUsers(currentPage - 1)" :disabled="currentPage === 1">上一頁</button>
        <span>第 [[ currentPage ]] 頁 / 共 [[ totalPages ]] 頁</span>
        <button @click="fetchUsers(currentPage + 1)"
                :disabled="currentPage === totalPages">下一頁</button>
      </div>
    </div>
  </div>
  <script>
  const userList = createApp({
    delimiters: ['[[', ']]'],
    data() {
      return {
        users: [],
        isLoading: false,
        searchQuery: '',
        roleFilter: '',
        selectedUsers: [],
        selectAll: false,
        activeMenu: null,
        currentPage: 1,
        totalPages: 1,
        pageSize: 10, // 每頁顯示的項目數，可調整
        menuPosition: {
          x: 0,
          y: 0
        }
      }
    },
    methods: {
      toggleMenu(userId) {
        if (this.activeMenu === userId) {
          this.activeMenu = null;
        } else {
          // 計算位置
          const button = event.currentTarget;
          const rect = button.getBoundingClientRect();
          this.menuPosition = {
            x: rect.right - 120, // 向左偏移 60px
            y: rect.bottom + 10 // 向下偏移 10px
          };
          this.activeMenu = userId;
        }
        event.stopPropagation();
      },
      handleClickOutside(event) {
        // 如果點擊的不是下拉選單或操作按鈕，則關閉選單
        if (this.activeMenu !== null) {
          const menu = document.querySelector('.menu.show');
          const button = document.querySelector('.btn-active-light-primary');
          
          if (menu && !menu.contains(event.target) && 
              button && !button.contains(event.target)) {
            this.activeMenu = null;
          }
        }
      },
      getMenuStyle(userId) {
        if (this.activeMenu !== userId) {
          return { display: 'none' };
        }
        return {
          'z-index': '107',
          'position': 'fixed',
          'inset': '0px auto auto 0px',
          'margin': '0px',
          'transform': `translate(${this.menuPosition.x}px, ${this.menuPosition.y}px)`
        };
      },
      getRoleText(profile) {
        if (profile.is_admin) return '管理員'
        if (profile.is_designer) return '設計師'
        if (profile.is_project_manager) return '專案經理'
        return '一般用戶'
      },
      getRoleBadgeClass(profile) {
        if (profile.is_admin) return 'badge-light-danger'
        if (profile.is_designer) return 'badge-light-success'
        if (profile.is_project_manager) return 'badge-light-primary'
        return 'badge-light-warning'
      },
      formatDate(dateString) {
        const date = new Date(dateString)
        return date.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' })
      },
      fetchUsers(page = 1) {
        this.currentPage = page
        this.isLoading = true
        let url = `/users/api?format=json&page=${page}&page_size=${this.pageSize}`
        
        if (this.searchQuery) {
          url += `&search=${encodeURIComponent(this.searchQuery)}`
        }
        if (this.roleFilter) {
          url += `&${this.roleFilter}=true`
        }

        fetch(url)
          .then(response => response.json())
          .then(data => {
            this.users = data.results // 假設後端返回 { results: [], count: X }
            this.totalPages = Math.ceil(data.count / this.pageSize)
          })
          .catch(error => console.error('Error fetching users:', error))
          .finally(() => {
            this.isLoading = false; // 無論成功或失敗，都將載入狀態設為 false
          });
      },
      deleteUser(userId) {
        if (confirm('確定要刪除此用戶嗎？')) {
          fetch(`/users/api/${userId}/`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          })
          .then(() => {
            this.fetchUsers(this.currentPage) // 重新獲取當前頁數據
            this.activeMenu = null
          })
          .catch(error => console.error('Error deleting user:', error))
        }
      }
    },
    watch: {
      users() {
        this.selectAll = this.selectedUsers.length === this.users.length && this.users.length > 0
      }
    },
    mounted() {
      this.fetchUsers();
      document.addEventListener('click', this.handleClickOutside);
    },
    unmounted() {
      // 組件銷毀時，移除事件監聽器以避免記憶體洩漏
      document.removeEventListener('click', this.handleClickOutside);
    }
  }).mount('#users_list')
  </script>
{% endblock content %}
